## HTTP的缓存代理

#### 简介

前面我们分别介绍了HTTP的缓存和代理服务，那么这两特性结合起来就是我们要介绍的缓存代理服务；

缓存代理服务即支持缓存控制的代理服务；

之前再说HTTP缓存时主要说了客户端的缓存控制，能够过减少响应时间，提升客户端使用的体验；

在整个链路上除了客户端有HTTP缓存，服务器的缓存也是非常有价值的；

本身HTTP请求的链路上是很漫长的，如果能在很近的地方就能拿到数据就能体现出缓存的价值和性能的提升，减轻了源服务器的压力；

#### 缓存代理服务

![HTTP缓存代理服务示意图](https://raw.githubusercontent.com/dashingqi/DQPicBeg/main/202206120945336.png)



当我们的代理服务器收到源服务器发来的响应数据时主要做了两件事

1. 将响应的数据转发给客户端；*
2. 将响应的数据存储到自己的Cache里；*
3. 同时当客户端再次发起同一次的请求时，代理服务器就拦截本次请求，从自己的Cache拿到响应的数据，返回304给到客户端；降低了客户端的等待时间，降低了源服务器的成本和压力；

#### 源服务器的缓存控制

之前在说HTTP缓存控制时，【Cache-Control】属性，对应了4个值max-age、no_store、no_cache、must_revalidate

这4种属性时用来约束客户端缓存的，同时在这里也能控制代理的缓存的；

对于代理服务来说它有两个角色【客户端】和【服务器】

对于真正的客户端的缓存来说它只能服务于一个客户端，但是对于代理服务器的缓存来说它要面对的是很多客户端，给这些客户端提供服务；

所以在这个基础上，就新增了一些属性用来控制缓存

##### private和public

###### private

表示缓存只能在客户端缓存，是属于用户私有的不能放到代理服务器上与别人共享；

###### public

缓存时完全开放的，谁都可以用，谁都可以存；缓存默认都是【public】

比如我们登录时存在Cookie中的身份信息就属于个人信息，不能存储在代理服务器上；

##### 代理缓存专用的属性

###### proxy-revalidate

要求代理的缓存过期后必须去验证；客户端不必回源，验证到代理这个环节就行；

###### s-maxage

该属性就是用来限制数据能在缓存服务器上能存活多久

s：share

maxage中间没有【-】

客户端继续使用max-age

###### no-transform

代理有时候会对缓存下载的数据做一些优化，比如把图片生成png格式，方便今后的请求处理

该属性就是告诉缓存服务器禁止这样做；

###### 源服务器缓存控制示意图

![HTTP缓存代理-服务器缓存](https://raw.githubusercontent.com/dashingqi/DQPicBeg/main/202206121157839.png)

其实这个过程就是把缓存使用的规则定义好告诉客户端；

###### 客户端的缓存控制示意图

![HTTP缓存代理-客户端缓存代理控制](https://raw.githubusercontent.com/dashingqi/DQPicBeg/main/202206121227240.png)

##### 新增字段的解析

###### max-stale

如果代理上的缓存过期了也可以接受，但是在过期X秒内的；

###### min-fresh

绝对不允许过期；

###### only-if-cached

表示只接受代理缓存的数据，不接受源服务器的响应；

如果代理上没有缓存或者缓存过期，就应该给客户端一个504